{
  "version": 3,
  "sources": ["../../../../config.js", "../../../../../../shared/utils.js", "../../../../../../shared/license.js", "../../../../../../shared/stripe.js", "../../../../../../shared/openai.js", "../../../../../../shared/auth.js", "../../../worker.js"],
  "sourceRoot": "/Users/billy/Downloads/Antigravity/projects/ai-factory/products/cover-letter/worker/.wrangler/tmp/deploy-tQMy8D",
  "sourcesContent": ["// \u4EA7\u54C1\u914D\u7F6E (Product Configuration)\nexport default {\n    name: \"AI Cover Letter Generator\",\n    slug: \"cover-letter\",\n    themeColor: \"#0f766e\",\n    model: \"gpt-4o-mini\",\n    systemPrompt: `You are a senior HR specialist and a top-tier career coach. Your job is to generate professional, compelling, personalized cover letters that match the user's background and the job description. Use a confident, human tone. Personalize based on user experience. Highlight achievements. Max 4 paragraphs. No generic filler. Include a strong closing.`,\n    prices: {\n        monthly: \"STRIPE_PRICE_ID_MONTHLY\", // \u5BF9\u5E94\u73AF\u5883\u53D8\u91CF\u540D\n        yearly: \"STRIPE_PRICE_ID_YEARLY\"    // \u5BF9\u5E94\u73AF\u5883\u53D8\u91CF\u540D\n    }\n};\n", "// \u5171\u4EAB\u5DE5\u5177\u5E93 (Shared Utilities)\n\n/**\n * \u6807\u51C6 JSON \u54CD\u5E94\n * @param {Object} data - \u54CD\u5E94\u6570\u636E\n * @param {number} status - HTTP \u72B6\u6001\u7801 (\u9ED8\u8BA4 200)\n * @returns {Response}\n */\nexport function jsonResponse(data, status = 200) {\n    return new Response(JSON.stringify(data), {\n        status,\n        headers: {\n            \"Content-Type\": \"application/json\",\n            \"Access-Control-Allow-Origin\": \"*\", // \u5141\u8BB8\u8DE8\u57DF\n            \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"Content-Type, x-license-key\"\n        }\n    });\n}\n\n/**\n * \u9519\u8BEF\u54CD\u5E94\n * @param {string} message - \u9519\u8BEF\u4FE1\u606F\n * @param {number} status - HTTP \u72B6\u6001\u7801 (\u9ED8\u8BA4 500)\n * @returns {Response}\n */\nexport function errorResponse(message, status = 500) {\n    return jsonResponse({ error: message }, status);\n}\n\n/**\n * \u5904\u7406 CORS \u9884\u68C0\u8BF7\u6C42\n * @returns {Response}\n */\nexport function handleCors() {\n    return new Response(null, {\n        status: 204,\n        headers: {\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"Content-Type, x-license-key\"\n        }\n    });\n}\n\n/**\n * \u7B80\u5355\u7684\u54C8\u5E0C\u51FD\u6570 (\u7528\u4E8E\u6307\u7EB9\u8BC6\u522B)\n * @param {string} str \n * @returns {Promise<string>}\n */\nexport async function hashString(str) {\n    const encoder = new TextEncoder();\n    const data = encoder.encode(str);\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);\n}\n\n/**\n * \u83B7\u53D6\u5F53\u524D\u65E5\u671F\u5B57\u7B26\u4E32 (YYYY-MM-DD)\n * @returns {string}\n */\nexport function getDateString() {\n    const now = new Date();\n    return now.toISOString().split('T')[0];\n}\n", "// \u8BB8\u53EF\u8BC1\u7BA1\u7406 (Shared License Logic)\nimport { getDateString } from \"./utils\";\n\n/**\n * \u751F\u6210\u968F\u673A\u8BB8\u53EF\u8BC1\u5BC6\u94A5\n * @returns {string}\n */\nexport function generateLicenseKey() {\n    return `yc_${crypto.randomUUID()}`;\n}\n\n/**\n * \u68C0\u67E5\u8BB8\u53EF\u8BC1\u6709\u6548\u6027\u548C\u4F7F\u7528\u60C5\u51B5\n * @param {Object} env - Cloudflare Env\n * @param {string} licenseKey - \u8BB8\u53EF\u8BC1\u5BC6\u94A5\n * @param {string} productSlug - \u4EA7\u54C1 Slug (\u7528\u4E8E\u547D\u540D\u7A7A\u95F4)\n * @returns {Promise<Object>} { valid: boolean, license: Object, reason: string }\n */\nexport async function checkLicense(env, licenseKey, productSlug) {\n    try {\n        // 1. \u5C1D\u8BD5\u8BFB\u53D6\u5E26\u547D\u540D\u7A7A\u95F4\u7684\u65B0 Key\n        let licenseData = await env.LICENSES.get(`${productSlug}:license:${licenseKey}`);\n\n        // 2. [Legacy Support] \u5982\u679C\u6CA1\u627E\u5230\uFF0C\u5C1D\u8BD5\u8BFB\u53D6\u65E7\u7684\u5168\u5C40 Key (\u4EC5\u9488\u5BF9 cover-letter \u7B49\u65E7\u4EA7\u54C1)\n        if (!licenseData) {\n            licenseData = await env.LICENSES.get(`license:${licenseKey}`);\n        }\n\n        if (!licenseData) {\n            return { valid: false, reason: 'not_found' };\n        }\n\n        const license = JSON.parse(licenseData);\n\n        // \u68C0\u67E5\u8BA1\u5212\u662F\u5426\u6709\u6548\n        if (!license.plan || !['monthly', 'yearly'].includes(license.plan)) {\n            return { valid: false, reason: 'invalid_plan' };\n        }\n\n        // \u66F4\u65B0\u4F7F\u7528\u6B21\u6570 (\u5F02\u6B65\u5199\u5165\uFF0C\u4E0D\u963B\u585E)\n        license.used = (license.used || 0) + 1;\n\n        // \u5199\u5165\u65F6\u4F18\u5148\u4F7F\u7528\u5E26\u547D\u540D\u7A7A\u95F4\u7684\u65B0\u683C\u5F0F\uFF0C\u9010\u6B65\u8FC1\u79FB\n        // \u6CE8\u610F\uFF1A\u5982\u679C\u539F\u6765\u662F\u65E7 Key\uFF0C\u8FD9\u91CC\u4F1A\u5199\u5165\u4E00\u4E2A\u65B0 Key\uFF0C\u5BFC\u81F4\u65E7 Key \u6570\u636E\u4E0D\u518D\u66F4\u65B0\u3002\n        // \u4E3A\u4E86\u4FDD\u6301\u4E00\u81F4\u6027\uFF0C\u5982\u679C\u8BFB\u53D6\u7684\u662F\u65E7 Key\uFF0C\u6700\u597D\u8FD8\u662F\u5199\u56DE\u65E7 Key\uFF1F\n        // \u7B80\u5316\u7B56\u7565\uFF1A\u59CB\u7EC8\u5199\u56DE\u8BFB\u53D6\u5230\u7684\u90A3\u4E2A Key\u3002\u4F46\u4E3A\u4E86\u91CD\u6784\uFF0C\u6211\u4EEC\u5E0C\u671B\u8FC1\u79FB\u3002\n        // \u59A5\u534F\u7B56\u7565\uFF1A\u65B0\u751F\u6210\u7684 License \u6C38\u8FDC\u5E26\u524D\u7F00\u3002\u65E7 License \u4FDD\u6301\u539F\u6837\u3002\n        // \u8FD9\u91CC\u6211\u4EEC\u7B80\u5355\u5904\u7406\uFF1A\u5982\u679C\u8BFB\u5230\u7684\u662F\u65E7\u7684\uFF0C\u5C31\u5199\u56DE\u65E7\u7684\u3002\u5982\u679C\u662F\u65B0\u7684\uFF0C\u5199\u56DE\u65B0\u7684\u3002\n        // \u4F46\u4E3A\u4E86\u4EE3\u7801\u7B80\u5355\uFF0C\u6211\u4EEC\u6682\u65F6\u53EA\u652F\u6301 \"\u8BFB\u53D6\u517C\u5BB9\"\u3002\u5199\u5165\u903B\u8F91\u5728 create \u65F6\u51B3\u5B9A\u3002\n\n        // \u91CD\u65B0\u5224\u65AD Key \u683C\u5F0F\n        const storageKey = await env.LICENSES.get(`${productSlug}:license:${licenseKey}`)\n            ? `${productSlug}:license:${licenseKey}`\n            : `license:${licenseKey}`;\n\n        await env.LICENSES.put(storageKey, JSON.stringify(license));\n\n        return { valid: true, license };\n    } catch (error) {\n        console.error('Error checking license:', error);\n        return { valid: false, reason: 'error' };\n    }\n}\n\n/**\n * \u68C0\u67E5\u514D\u8D39\u5C42\u7EA7\u4F7F\u7528\u60C5\u51B5\n * @param {Object} env - Cloudflare Env\n * @param {string} fingerprint - \u7528\u6237\u6307\u7EB9\n * @param {string} productSlug - \u4EA7\u54C1 Slug\n * @returns {Promise<Object>} { allowed: boolean, count: number }\n */\nexport async function checkFreeUsage(env, fingerprint, productSlug) {\n    const dateStr = getDateString();\n    // \u4F7F\u7528\u547D\u540D\u7A7A\u95F4 Key: slug:free:fingerprint:date\n    const key = `${productSlug}:free:${fingerprint}:${dateStr}`;\n\n    try {\n        const usageData = await env.FREE_USAGE.get(key);\n        let usage = usageData ? JSON.parse(usageData) : { count: 0 };\n\n        if (usage.count >= 3) {\n            return { allowed: false, count: usage.count };\n        }\n\n        // \u589E\u52A0\u8BA1\u6570\u5E76\u4FDD\u5B58\n        usage.count += 1;\n        await env.FREE_USAGE.put(key, JSON.stringify(usage), { expirationTtl: 86400 }); // 24\u5C0F\u65F6\n\n        return { allowed: true, count: usage.count };\n    } catch (error) {\n        console.error('Error checking free usage:', error);\n        // \u51FA\u9519\u65F6\u9ED8\u8BA4\u5141\u8BB8\uFF0C\u907F\u514D\u963B\u65AD\u7528\u6237\n        return { allowed: true, count: 0 };\n    }\n}\n\n/**\n * \u521B\u5EFA\u5E76\u4FDD\u5B58\u65B0\u8BB8\u53EF\u8BC1\n * @param {Object} env \n * @param {string} productSlug \n * @param {string} plan \n * @returns {Promise<string>} licenseKey\n */\nexport async function createLicense(env, productSlug, plan) {\n    const licenseKey = generateLicenseKey();\n    const licenseData = {\n        plan: plan,\n        createdAt: new Date().toISOString(),\n        max: -1, // -1 \u8868\u793A\u65E0\u9650\n        used: 0\n    };\n\n    // \u59CB\u7EC8\u4F7F\u7528\u5E26\u547D\u540D\u7A7A\u95F4\u7684\u65B0\u683C\u5F0F\u4FDD\u5B58\n    await env.LICENSES.put(`${productSlug}:license:${licenseKey}`, JSON.stringify(licenseData));\n    return licenseKey;\n}\n", "// Stripe \u652F\u4ED8\u903B\u8F91 (Shared Stripe Logic)\n\n/**\n * \u521B\u5EFA Stripe Checkout Session\n * @param {Object} env - Cloudflare Env\n * @param {string} priceId - Stripe Price ID\n * @param {string} successUrl - \u6210\u529F\u56DE\u8C03 URL\n * @param {string} cancelUrl - \u53D6\u6D88\u56DE\u8C03 URL\n * @returns {Promise<Object>} { id, url }\n */\nexport async function createCheckoutSession(env, priceId, successUrl, cancelUrl) {\n    if (!env.STRIPE_SECRET_KEY) {\n        throw new Error(\"STRIPE_SECRET_KEY not configured\");\n    }\n\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\n        method: 'POST',\n        headers: {\n            'Authorization': `Bearer ${env.STRIPE_SECRET_KEY}`,\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: new URLSearchParams({\n            mode: 'subscription',\n            'line_items[0][price]': priceId,\n            'line_items[0][quantity]': '1',\n            success_url: successUrl,\n            cancel_url: cancelUrl\n        })\n    });\n\n    if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`Stripe API error: ${response.status} ${errorText}`);\n    }\n\n    return await response.json();\n}\n\n/**\n * \u9A8C\u8BC1 Stripe Session \u5E76\u83B7\u53D6\u8BA2\u9605\u4FE1\u606F\n * @param {Object} env - Cloudflare Env\n * @param {string} sessionId - Stripe Session ID\n * @returns {Promise<Object>} Session Object\n */\nexport async function verifyStripeSession(env, sessionId) {\n    if (!env.STRIPE_SECRET_KEY) {\n        throw new Error(\"STRIPE_SECRET_KEY not configured\");\n    }\n\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}?expand[]=subscription`, {\n        method: 'GET',\n        headers: {\n            'Authorization': `Bearer ${env.STRIPE_SECRET_KEY}`\n        }\n    });\n\n    if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`Stripe API error: ${response.status} ${errorText}`);\n    }\n\n    return await response.json();\n}\n", "// OpenAI API \u5C01\u88C5 (Shared OpenAI Wrapper)\n\n/**\n * \u8C03\u7528 OpenAI API\n * @param {string} apiKey - OpenAI API Key\n * @param {string} model - \u6A21\u578B\u540D\u79F0 (\u5982 gpt-4o-mini)\n * @param {Array} messages - \u6D88\u606F\u6570\u7EC4\n * @returns {Promise<string>} - AI \u751F\u6210\u7684\u5185\u5BB9\n */\nexport async function callOpenAI(apiKey, model, messages) {\n    if (!apiKey) {\n        throw new Error(\"OPENAI_API_KEY not configured\");\n    }\n\n    const res = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n            Authorization: `Bearer ${apiKey}`,\n            \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify({ model, messages })\n    });\n\n    if (!res.ok) {\n        const errorText = await res.text();\n        console.error(\"OpenAI API error:\", res.status, errorText);\n        throw new Error(`OpenAI API error: ${res.status} ${errorText}`);\n    }\n\n    const json = await res.json();\n    return json.choices?.[0]?.message?.content || \"\";\n}\n", "// Authentication Logic (Shared)\nimport { jsonResponse, errorResponse, getDateString } from \"./utils.js\";\n\n/**\n * Generate a random token\n */\nfunction generateToken() {\n    return crypto.randomUUID();\n}\n\n/**\n * Send Magic Link (Mock for now)\n * Stores token in KV and returns the link.\n * @param {Object} env \n * @param {string} slug \n * @param {string} email \n * @param {string} baseUrl \n */\nexport async function sendMagicLink(env, slug, email, baseUrl) {\n    const token = generateToken();\n    const expiresAt = Date.now() + 15 * 60 * 1000; // 15 mins\n\n    // Store auth token: [slug]:auth:[token]\n    await env.LICENSES.put(`${slug}:auth:${token}`, JSON.stringify({ email, expiresAt }), { expirationTtl: 900 });\n\n    // In a real app, send email here.\n    // For now, return the link.\n    const magicLink = `${baseUrl}/?token=${token}`;\n\n    console.log(`Magic Link for ${email}: ${magicLink}`);\n    return magicLink;\n}\n\n/**\n * Verify Magic Link Token\n * @param {Object} env \n * @param {string} slug \n * @param {string} token \n */\nexport async function verifyMagicLink(env, slug, token) {\n    const key = `${slug}:auth:${token}`;\n    const data = await env.LICENSES.get(key);\n\n    if (!data) {\n        return { valid: false, error: \"Invalid or expired token\" };\n    }\n\n    const { email, expiresAt } = JSON.parse(data);\n    if (Date.now() > expiresAt) {\n        return { valid: false, error: \"Token expired\" };\n    }\n\n    // Delete used token\n    await env.LICENSES.delete(key);\n\n    // Create Session\n    const sessionToken = generateToken();\n    const sessionExpiresAt = Date.now() + 7 * 24 * 60 * 60 * 1000; // 7 days\n\n    // Store session: [slug]:session:[token]\n    await env.LICENSES.put(`${slug}:session:${sessionToken}`, JSON.stringify({ email, expiresAt: sessionExpiresAt }), { expirationTtl: 604800 });\n\n    // Get or Create User Profile\n    const userKey = `${slug}:user:${email}`;\n    let user = await env.LICENSES.get(userKey);\n\n    if (!user) {\n        user = { email, plan: 'free', createdAt: new Date().toISOString() };\n        await env.LICENSES.put(userKey, JSON.stringify(user));\n    } else {\n        user = JSON.parse(user);\n    }\n\n    return { valid: true, sessionToken, user };\n}\n\n/**\n * Verify Session Token\n * @param {Object} env \n * @param {string} slug \n * @param {string} sessionToken \n */\nexport async function verifySession(env, slug, sessionToken) {\n    const key = `${slug}:session:${sessionToken}`;\n    const data = await env.LICENSES.get(key);\n\n    if (!data) {\n        return { valid: false };\n    }\n\n    const { email, expiresAt } = JSON.parse(data);\n    if (Date.now() > expiresAt) {\n        return { valid: false };\n    }\n\n    // Get User Profile to check plan\n    const userKey = `${slug}:user:${email}`;\n    const userData = await env.LICENSES.get(userKey);\n    const user = userData ? JSON.parse(userData) : { email, plan: 'free' };\n\n    return { valid: true, email, user };\n}\n\n/**\n * Update User Plan (e.g. after Stripe payment)\n * @param {Object} env \n * @param {string} slug \n * @param {string} email \n * @param {string} plan \n * @param {string} licenseKey \n */\nexport async function updateUserPlan(env, slug, email, plan, licenseKey) {\n    const userKey = `${slug}:user:${email}`;\n    let user = await env.LICENSES.get(userKey);\n\n    if (user) {\n        user = JSON.parse(user);\n    } else {\n        user = { email, createdAt: new Date().toISOString() };\n    }\n\n    user.plan = plan;\n    user.licenseKey = licenseKey;\n\n    await env.LICENSES.put(userKey, JSON.stringify(user));\n    return user;\n}\n", "// Refactored Worker using Shared Core\nimport config from \"../config.js\";\nimport { checkLicense, checkFreeUsage, createLicense } from \"../../../shared/license.js\";\nimport { createCheckoutSession, verifyStripeSession } from \"../../../shared/stripe.js\";\nimport { callOpenAI } from \"../../../shared/openai.js\";\nimport { jsonResponse, errorResponse, handleCors, hashString } from \"../../../shared/utils.js\";\nimport { sendMagicLink, verifyMagicLink, verifySession, updateUserPlan } from \"../../../shared/auth.js\";\n\n// Handle /api/generate\nasync function handleGenerate(request, env) {\n  try {\n    const { input, target_language = \"en\" } = await request.json();\n\n    if (!input) return errorResponse(\"Missing input field\", 400);\n    if (!env.OPENAI_API_KEY) return errorResponse(\"OPENAI_API_KEY not configured\", 500);\n\n    // 1. Auth / License / Free Usage Check\n    const authHeader = request.headers.get(\"Authorization\");\n    const licenseKey = request.headers.get(\"x-license-key\");\n    let canProceed = false;\n    let userPlan = 'free';\n\n    // A. Check Session (Login)\n    if (authHeader && authHeader.startsWith(\"Bearer \")) {\n      const token = authHeader.split(\" \")[1];\n      const session = await verifySession(env, config.slug, token);\n      if (session.valid) {\n        // Logged in user\n        if (session.user.plan === 'monthly' || session.user.plan === 'yearly') {\n          canProceed = true; // Paid user = unlimited\n          userPlan = session.user.plan;\n        } else {\n          // Free user logged in - still subject to limits? \n          // For now, let's say logged in free users still get IP limits or maybe slightly higher?\n          // Let's stick to IP limits for free users for simplicity, or we could track usage by email.\n          // To keep it simple and robust: Fallback to IP check if plan is free.\n        }\n      }\n    }\n\n    // B. Check License Key (Legacy / Direct)\n    if (!canProceed && licenseKey) {\n      const check = await checkLicense(env, licenseKey, config.slug);\n      if (check.valid) {\n        canProceed = true;\n        userPlan = check.license.plan;\n      }\n    }\n\n    // C. Free Tier Fallback\n    if (!canProceed) {\n      const ip = request.headers.get(\"CF-Connecting-IP\") || \"unknown\";\n      const ua = request.headers.get(\"User-Agent\") || \"unknown\";\n      const fingerprint = await hashString(`${ip}:${ua}`);\n\n      const freeCheck = await checkFreeUsage(env, fingerprint, config.slug);\n      if (!freeCheck.allowed) {\n        return jsonResponse({\n          error: \"free_limit_reached\",\n          message: \"Free limit reached. Please upgrade to continue.\",\n          upgrade_url: \"/#pricing\"\n        }, 200);\n      }\n    }\n\n    // 2. Prepare Prompt\n    const languageNames = {\n      en: \"English\", zh: \"Chinese\", es: \"Spanish\", fr: \"French\",\n      de: \"German\", pt: \"Portuguese\", ja: \"Japanese\", ko: \"Korean\",\n      ar: \"Arabic\", hi: \"Hindi\"\n    };\n    const targetLangName = languageNames[target_language] || \"English\";\n\n    // Inject dynamic values into system prompt if needed, or just append instructions\n    // Here we append the language instruction to the static system prompt from config\n    const systemPrompt = `${config.systemPrompt}\n    \nIMPORTANT: Generate the content in ${targetLangName}. The tone, style, and format should match professional standards and cultural conventions of ${targetLangName}-speaking regions.\nRequirements:\n- Use a confident, human-sounding tone appropriate for ${targetLangName} business communication\n- Personalize using the user's experience and background\n- Highlight achievements and metrics when available\n- Format cleanly: maximum 4 paragraphs\n- Avoid generic filler content\n- Include a strong, professional closing statement\n- Ensure the content is written entirely in ${targetLangName} with proper grammar and cultural appropriateness`;\n\n    const messages = [\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: input }\n    ];\n\n    // 3. Call AI\n    const output = await callOpenAI(env.OPENAI_API_KEY, config.model, messages);\n\n    return jsonResponse({ output });\n\n  } catch (error) {\n    console.error(\"Generate error:\", error);\n    return errorResponse(error.message || \"Internal server error\");\n  }\n}\n\n// Handle /api/checkout\nasync function handleCheckout(request, env) {\n  try {\n    const { plan } = await request.json();\n    if (!plan || !['monthly', 'yearly'].includes(plan)) {\n      return errorResponse(\"Invalid plan. Must be 'monthly' or 'yearly'\", 400);\n    }\n\n    // Resolve Price ID from Env using Config mapping\n    const envVarName = config.prices[plan]; // e.g. \"STRIPE_PRICE_ID_MONTHLY\"\n    const priceId = env[envVarName];\n\n    if (!priceId) {\n      return errorResponse(`${envVarName} not configured`, 500);\n    }\n\n    // Create Session\n    const baseUrl = env.APP_BASE_URL || 'https://yourcoverai.billyus2025.workers.dev';\n    const successUrl = `${baseUrl}/success.html?session_id={CHECKOUT_SESSION_ID}`;\n    const cancelUrl = `${baseUrl}/cancel.html`;\n\n    const session = await createCheckoutSession(env, priceId, successUrl, cancelUrl);\n\n    return jsonResponse({ id: session.id, url: session.url });\n\n  } catch (error) {\n    console.error(\"Checkout error:\", error);\n    return errorResponse(error.message || \"Internal server error\");\n  }\n}\n\n// Handle /api/checkout/success\nasync function handleCheckoutSuccess(request, env) {\n  try {\n    const url = new URL(request.url);\n    const sessionId = url.searchParams.get('session_id');\n    if (!sessionId) return errorResponse(\"Missing session_id\", 400);\n\n    const session = await verifyStripeSession(env, sessionId);\n\n    if (session.payment_status !== 'paid' && session.status !== 'complete') {\n      return errorResponse(\"Payment not completed\", 400);\n    }\n\n    // Determine Plan\n    let plan = 'monthly';\n    const subscription = session.subscription;\n    if (subscription && subscription.items && subscription.items.data[0]) {\n      const priceId = subscription.items.data[0].price.id;\n      // Check against Yearly Price ID\n      const yearlyPriceId = env[config.prices.yearly];\n      if (priceId === yearlyPriceId) {\n        plan = 'yearly';\n      }\n    }\n\n    // Create License\n    const licenseKey = await createLicense(env, config.slug, plan);\n\n    // If we have customer email from Stripe, link it to user account\n    // Note: Stripe session object has customer_details.email\n    if (session.customer_details && session.customer_details.email) {\n      const email = session.customer_details.email;\n      await updateUserPlan(env, config.slug, email, plan, licenseKey);\n    }\n\n    return jsonResponse({\n      status: \"ok\",\n      license: licenseKey,\n      plan: plan\n    });\n\n  } catch (error) {\n    console.error(\"Checkout success error:\", error);\n    return errorResponse(error.message || \"Internal server error\");\n  }\n}\n\n// Main Router\nexport default {\n  async fetch(request, env) {\n    try {\n      const url = new URL(request.url);\n      const pathname = url.pathname;\n      const method = request.method;\n\n      // CORS Preflight\n      if (method === \"OPTIONS\") return handleCors();\n\n      // Routes\n      if (pathname === \"/api/generate\" && method === \"POST\") {\n        return handleGenerate(request, env);\n      }\n\n      // Support both new and legacy checkout routes\n      if ((pathname === \"/api/checkout\" || pathname === \"/api/create-checkout-session\" || pathname === \"/create-checkout-session\") && method === \"POST\") {\n        return handleCheckout(request, env);\n      }\n\n      if ((pathname === \"/api/checkout/success\" || pathname === \"/checkout-success\") && method === \"GET\") {\n        return handleCheckoutSuccess(request, env);\n      }\n\n      // \u8DEF\u7531: /api/health\n      if (pathname === \"/api/health\" && method === \"GET\") {\n        return jsonResponse({ status: \"ok\", version: \"1.0.0\" });\n      }\n\n      // \u8DEF\u7531: /api/license/verify\n      if (pathname === \"/api/license/verify\" && method === \"POST\") {\n        try {\n          const { license_key } = await request.json();\n          if (!license_key) return errorResponse(\"Missing license_key\", 400);\n          const check = await checkLicense(env, license_key, config.slug);\n          return jsonResponse(check);\n        } catch (e) {\n          return errorResponse(e.message, 500);\n        }\n      }\n\n      // \u8DEF\u7531: /api/auth/send-link\n      if (pathname === \"/api/auth/send-link\" && method === \"POST\") {\n        const { email } = await request.json();\n        if (!email) return errorResponse(\"Missing email\", 400);\n        const baseUrl = env.APP_BASE_URL || \"https://yourcoverai.com\";\n        const link = await sendMagicLink(env, config.slug, email, baseUrl);\n        return jsonResponse({ status: \"ok\", message: \"Magic link sent\", link }); // Returning link for testing\n      }\n\n      // \u8DEF\u7531: /api/auth/verify-link\n      if (pathname === \"/api/auth/verify-link\" && method === \"POST\") {\n        const { token } = await request.json();\n        if (!token) return errorResponse(\"Missing token\", 400);\n        const result = await verifyMagicLink(env, config.slug, token);\n        if (!result.valid) return errorResponse(result.error, 401);\n        return jsonResponse({ status: \"ok\", sessionToken: result.sessionToken, user: result.user });\n      }\n\n      // \u8DEF\u7531: /api/auth/me\n      if (pathname === \"/api/auth/me\" && method === \"GET\") {\n        const authHeader = request.headers.get(\"Authorization\");\n        if (!authHeader || !authHeader.startsWith(\"Bearer \")) return errorResponse(\"Unauthorized\", 401);\n        const token = authHeader.split(\" \")[1];\n        const session = await verifySession(env, config.slug, token);\n        if (!session.valid) return errorResponse(\"Invalid session\", 401);\n        return jsonResponse({ status: \"ok\", user: session.user });\n      }\n\n      // 404\n      return errorResponse(`Route ${pathname} not found`, 404);\n    } catch (err) {\n      console.error(\"Global Worker Error:\", err);\n      return errorResponse(err.message || \"Internal Server Error\", 500);\n    }\n  }\n};\n"],
  "mappings": "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",
  "names": []
}
